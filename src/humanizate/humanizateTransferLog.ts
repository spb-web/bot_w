import type { TransferEvent } from '@/watchers'
import type { MessagePayloadType } from '@/libs/TgBot'
import { AddressZero } from '@ethersproject/constants'
import { project } from '../projects'
import { targetPriceFetcher } from '../libs/TargetPriceFetcher'
import { toLocaleString } from '../utils/toLocaleString'
import { getButtons } from './getButtons'
import { getWalletString } from './getWalletString'
import { BaseTargetEventWithTransaction } from '@/entries'

export const humanizateTransferLog = (log:BaseTargetEventWithTransaction<TransferEvent>):MessagePayloadType => {
  const price = targetPriceFetcher.getPrice()
  const amountCost = log.amount.times(price)
  const symbol = log.token.symbol
  let text:string

  const from = getWalletString(log.from, log.addressesInfo)
  const to = getWalletString(log.to, log.addressesInfo)
  const tags = [`#${project.name}`]

  if (log.from === AddressZero) {
    text = `ü™Ñ –û—Ç—á–µ–∫–∞–Ω–µ–Ω–æ ${toLocaleString(log.amount)} ${symbol} (~ $${toLocaleString(amountCost, true)}) –Ω–∞ –∞–¥—Ä–µ—Å ${to}`
    tags.push('#–û—Ç—á–µ–∫–∞–Ω–µ–Ω–æ')
  } else {
    text = `üì© –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${toLocaleString(log.amount)} ${symbol} (~ $${toLocaleString(amountCost, true)}) \n\n–∏–∑ ${from} \n–≤ ${to}`
    tags.push('#–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')
  }

  text += `\n\n${tags.join(' ')}`

  return {
    chatId: project.telegram.whalesChatId,
    text,
    extra: {
      reply_markup: getButtons(log),
    },
  }
}
